import {useEffect, useRef, useState} from 'react';
import {cc} from "../common/variables";
import Image from "next/image";
var layoutGeometry = require('justified-layout');


function MyImageGallery(options) {
    handleErrorChecking(options);

    const galleryElementRef = useRef(null);
    const [galleryElements, setGalleryElements] = useState(null);

    const optionsWithDefaults = addDefaultsToOptions(options);
    const {containerPadding, containerWidth, targetRowHeight, justifyFinalRow, imagePadding, maxRows, showIncompleteRows, images} = {...optionsWithDefaults};

        useEffect(() => {
            setGalleryElements(calculateGalleryLayout(optionsWithDefaults, galleryElementRef));

            window.addEventListener('resize', () => setGalleryElements(calculateGalleryLayout(optionsWithDefaults, galleryElementRef)));
            return () => {
                window.removeEventListener('resize', () => setGalleryElements(calculateGalleryLayout(optionsWithDefaults, galleryElementRef)));
            }
        }, []);

    return (
            <div className={"njGallery"}
                style={
                    {
                    "width": (containerWidth),
                    "display": "flex",
                    "flexWrap": "wrap",
                    "padding": (containerPadding/2) + "px " + (containerPadding/2) + "px " + (containerPadding/2) + "px " + (containerPadding/2) + "px",
                    }
                }
                ref={galleryElementRef && galleryElementRef}
            >
                {galleryElements && galleryElements}
            </div>
    );
}

function calculateGalleryLayout(calculatoroptions, galleryContainer){
    galleryContainer = galleryContainer.current;
    const optionsCopy = {...calculatoroptions}

    const {
        images,
        containerPadding,
        containerWidth,
        targetRowHeight,
        imagePadding,
        maxRows,
        showIncompleteRows,
    } = optionsCopy;

    const imageDimensions = images.map((e, k) => {
        return {width: e.width, height: e.height}
    });

    const autoGeneratedWidth = Math.trunc(+galleryContainer.offsetWidth-1); // -1 because otherwise at some widths, the last image in a row jumps to the next row. Total width might be e.g. 0.42 pixels too large.
    const imageLayout = layoutGeometry(imageDimensions, {
            containerWidth: containerWidth | autoGeneratedWidth,
            targetRowHeight: targetRowHeight | 300,
            containerPadding: containerPadding,
            boxSpacing: imagePadding,
            maxNumRows: maxRows,
            showWidows: showIncompleteRows,
        }
    );

    const imagesCopy = [...images];
    let imageLayoutAndOptions = [];
    for (let i = 0; i < imageLayout.boxes.length; i++){
        imageLayoutAndOptions[i] = {};
        imageLayoutAndOptions[i].boxHeight = imageLayout.boxes[i].height;
        imageLayoutAndOptions[i].boxWidth = imageLayout.boxes[i].width;
        imageLayoutAndOptions[i].imgSrc = imagesCopy[i].src;
        imageLayoutAndOptions[i].imgBlurSrc = imagesCopy[i].blurSrc;
        imageLayoutAndOptions[i].alt = imagesCopy[i].alt;
    }

    return imageLayoutAndOptions.map((e, k) => {
        e.height = Math.trunc(+e.boxHeight);
        e.width = Math.trunc(+e.boxWidth);

        return (
            <div style={
                    {
                    "margin": (imagePadding.vertical/2) + "px " + (imagePadding.horizontal/2) + "px " + (imagePadding.vertical/2) + "px " + (imagePadding.horizontal/2) + "px",
                    }
                }
                key={k}
            >
                <Image
                    src={e.imgSrc}
                    blurDataURL={e.imgBlurSrc}
                    placeholder={e.imgBlurSrc && "blur"}
                    className={"njGalleryImage"}
                    width={e.boxWidth}
                    height={e.boxHeight}
                    alt={e.alt}
                />
            </div>
        );
    });
}

function handleErrorChecking(options){
    const optionsCopy = {...options}
    const {containerPadding, images} = optionsCopy;

    if (!images) throw new Error("You must include images.");
    if (!images) throw new Error("You must include images.");
    for (let entry of images){
        if (!entry.src) throw new Error("Every image must include a sorce (URL).");
        if (!entry.width) throw new Error("Every image must include a width value.");
        if (!entry.height) throw new Error("Every image must include a height value.");
        if (typeof entry.width !== "number") throw new Error("Image width must be a number, not a string.");
        if (typeof entry.height !== "number") throw new Error("Image height must be a number, not a string.");
    }

    if (containerPadding && containerPadding % 2 !== 0) throw new Error("Padding must be an even number");
}

function addDefaultsToOptions(options){
    const optionsCopy = {...options}

    return {
        images: optionsCopy.images,
        containerPadding: optionsCopy.containerPadding || 10,
        containerWidth: optionsCopy.containerWidth || "100%",
        targetRowHeight: optionsCopy.containerWidth || 300,
        justifyFinalRow: optionsCopy.justifyFinalRow || false,
        imagePadding: optionsCopy.imagePadding || {vertical: 10, horizontal: 10},
        maxRows: optionsCopy.hideIncompleteRows || Number.POSITIVE_INFINITY,
        showIncompleteRows: optionsCopy.maxRows || true,
    }
}

export default MyImageGallery;
